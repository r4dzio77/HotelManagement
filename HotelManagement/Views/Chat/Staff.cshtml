@using HotelManagement.Models
@{
    ViewData["Title"] = "Wiadomości";

    var newChats = ViewBag.NewChats as List<ChatConversation> ?? new();
    var oldChats = ViewBag.OldChats as List<ChatConversation> ?? new();
    var active = ViewBag.ActiveConversation as ChatConversation;

    string displayName = active?.User != null
        ? (!string.IsNullOrWhiteSpace(active.User.FirstName)
            ? $"{active.User.FirstName} {active.User.LastName}"
            : active.User.UserName)
        : "";
}

<style>
    body {
        overflow: hidden;
    }

    .chat-shell {
        height: calc(100vh - 120px);
        overflow: hidden;
    }

    .chat-column {
        height: 100%;
        overflow: hidden;
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        background: #f8fafc;
    }

    .chat-tabs {
        gap: .5rem;
        padding: 1rem;
    }

    .chat-tab {
        border: 1px solid rgba(148,163,184,.4);
        border-radius: 999px;
        padding: .35rem .85rem;
        font-size: .78rem;
        font-weight: 600;
        background: #fff;
        color: #475569;
        transition: .15s ease;
        cursor: pointer;
    }

        .chat-tab.active {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb;
            box-shadow: 0 6px 14px rgba(37,99,235,.25);
        }

        .chat-tab.new.active {
            background: #dc2626;
            border-color: #dc2626;
            box-shadow: 0 6px 14px rgba(220,38,38,.25);
        }

        .chat-tab .badge {
            font-size: .65rem;
            padding: .15rem .45rem;
            border-radius: 999px;
        }
</style>

<div class="row g-0 chat-shell">

    <!-- LEWA KOLUMNA -->
    <div class="col-4 border-end bg-white chat-column">

        <!-- ✅ POPRAWNE TABY -->
        <div class="nav chat-tabs" role="tablist">

            <button class="chat-tab new active"
                    id="tab-new"
                    data-bs-toggle="tab"
                    data-bs-target="#new"
                    type="button"
                    role="tab"
                    aria-controls="new"
                    aria-selected="true">
                Nowe
                <span class="badge bg-white text-danger ms-1">@newChats.Count</span>
            </button>

            <button class="chat-tab"
                    id="tab-old"
                    data-bs-toggle="tab"
                    data-bs-target="#old"
                    type="button"
                    role="tab"
                    aria-controls="old"
                    aria-selected="false">
                Stare
                <span class="badge bg-secondary ms-1">@oldChats.Count</span>
            </button>
        </div>

        <div class="tab-content overflow-auto" style="height:100%;">

            <div class="tab-pane fade show active" id="new" role="tabpanel" aria-labelledby="tab-new">
                @foreach (var chat in newChats)
                {
                    <a href="/Chat/Staff?conversationId=@chat.Id"
                       class="d-block px-3 py-3 border-bottom text-decoration-none bg-danger-subtle">
                        <div class="fw-semibold">@chat.User.UserName</div>
                        <div class="small">
                            <span class="badge bg-danger">Czeka na hotel</span>
                        </div>
                    </a>
                }
            </div>

            <div class="tab-pane fade" id="old" role="tabpanel" aria-labelledby="tab-old">
                @foreach (var chat in oldChats)
                {
                    var last = chat.Messages.OrderByDescending(m => m.SentAt).FirstOrDefault();

                    <a href="/Chat/Staff?conversationId=@chat.Id"
                       class="d-block px-3 py-3 border-bottom text-decoration-none">
                        <div class="fw-semibold">@chat.User.UserName</div>
                        <div class="small text-muted">
                            @(last?.SentAt.ToLocalTime().ToString("dd.MM HH:mm"))
                        </div>
                    </a>
                }
            </div>

        </div>
    </div>

    <!-- PRAWA KOLUMNA -->
    <div class="col-8 d-flex flex-column bg-white chat-column">

        @if (active == null)
        {
            <div class="h-100 d-flex align-items-center justify-content-center text-muted">
                Wybierz rozmowę z listy po lewej
            </div>
        }
        else
        {
            <div class="border-bottom px-4 py-3">
                <div class="fw-semibold fs-5">
                    Rozmowa z @displayName
                </div>
            </div>

            <div id="chatMessages" class="chat-messages px-4 py-3">
                @foreach (var msg in active.Messages.OrderBy(m => m.SentAt))
                {
                    var isMine = msg.IsFromStaff;

                    <div class="d-flex mb-3 @(isMine ? "justify-content-end" : "justify-content-start")">
                        <div class="p-3 rounded-4 shadow-sm"
                             style="max-width:70%;
                                            background:@(isMine ? "#2563eb" : "#ffffff");
                                            color:@(isMine ? "white" : "#0f172a");">

                            <div class="small fw-semibold mb-1">
                                @(isMine ? "Recepcja" : "Gość")
                            </div>

                            <div>@msg.Content</div>

                            <div class="small mt-1" style="opacity:.75;">
                                @msg.SentAt.ToLocalTime().ToString("HH:mm")
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="border-top px-4 py-3">
                <form asp-action="SendMessage" method="post" id="chatForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="conversationId" value="@active.Id" />

                    <textarea name="content"
                          id="chatInput"
                          class="form-control mb-2"
                          rows="2"
                          placeholder="Odpisz… (Enter = wyślij)"
                          required></textarea>

                    <button class="btn btn-primary px-4">Wyślij</button>
                </form>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        const container = document.getElementById("chatMessages");
        if (container) container.scrollTop = container.scrollHeight;

        document.getElementById("chatInput")?.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                document.getElementById("chatForm").submit();
            }
        });
    </script>
}
