@using HotelManagement.Models
@using HotelManagement.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@inject UserManager<ApplicationUser> UserManager
@inject HotelManagementContext DbContext

@model IEnumerable<HotelManagement.Models.RoomType>

@{
    ViewData["Title"] = "Dostępne typy pokoi";

    var isAdminOrManager = (bool?)ViewBag.IsAdminOrManager ?? false;

    // dostępność z kontrolera – Dictionary<int, int> (RoomTypeId -> min dostępność w całym pobycie)
    var availability = ViewBag.Availability as Dictionary<int, int>;

    string checkIn = ViewBag.CheckIn as string;
    string checkOut = ViewBag.CheckOut as string;
    bool hasSearch = !string.IsNullOrEmpty(checkIn) && !string.IsNullOrEmpty(checkOut);

    decimal? minPrice = Model?.Any() == true ? Model.Min(rt => rt.PricePerNight) : 0m;
    decimal? maxPrice = Model?.Any() == true ? Model.Max(rt => rt.PricePerNight) : 0m;

    // ====== LOJALNOŚĆ – wyliczenie rabatu ======
    ApplicationUser? currentUser = null;
    bool hasLoyaltyCard = false;
    string? loyaltyStatus = null;
    decimal loyaltyDiscount = 0m;
    int loyaltyDiscountPercent = 0;

    if (User.Identity != null && User.Identity.IsAuthenticated)
    {
        currentUser = await UserManager.GetUserAsync(User);
        if (currentUser?.GuestId != null)
        {
            var guest = await DbContext.Guests
                .FirstOrDefaultAsync(g => g.Id == currentUser.GuestId.Value);

            if (guest != null && guest.HasLoyaltyCard)
            {
                hasLoyaltyCard = true;
                loyaltyStatus = guest.LoyaltyStatus.ToString();
                loyaltyDiscount = guest.GetDiscountPercentage();
                loyaltyDiscountPercent = (int)(loyaltyDiscount * 100);
            }
        }
    }
}

<style>
    .hero {
        background: radial-gradient(1200px 500px at 10% 0%, rgba(99,102,241,.15), transparent 60%), radial-gradient(900px 400px at 90% 10%, rgba(16,185,129,.15), transparent 60%);
        border-radius: 1.5rem;
        padding: 2rem 2.5rem;
        margin-bottom: 2rem;
        color: #111827;
        position: relative;
        overflow: hidden;
    }

    .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .25rem .7rem;
        border-radius: 999px;
        background: rgba(255,255,255,.9);
        font-size: .8rem;
        color: #4b5563;
    }

    .hero-title {
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: .5rem;
    }

    .hero-subtitle {
        color: #4b5563;
        max-width: 40rem;
    }

    .filter-card {
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(15,23,42,.06);
        border: 1px solid #e5e7eb;
    }

    .room-card {
        border-radius: 1.25rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 30px rgba(15,23,42,.05);
        overflow: hidden;
        transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
        background: #fff;
    }

        .room-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 40px rgba(15,23,42,.08);
            border-color: #c7d2fe;
        }

    .room-image {
        height: 190px;
        object-fit: cover;
        width: 100%;
    }

    .price-line-through {
        text-decoration: line-through;
        color: #9ca3af;
        font-size: .9rem;
    }

    .loyalty-banner {
        border-radius: 1rem;
        background: linear-gradient(135deg, #f97316, #facc15);
        color: #111827;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }
</style>

<div class="container py-4">

    <div class="hero">
        <div class="d-flex justify-content-between flex-wrap gap-3 align-items-start">
            <div>
                <div class="hero-badge mb-2">
                    <i class="bi bi-calendar-check"></i>
                    <span>Rezerwacja online</span>
                </div>
                <h1 class="hero-title">Wybierz idealny pokój</h1>
                <p class="hero-subtitle mb-0">
                    Najpierw wybierz daty pobytu, aby zobaczyć dostępne typy pokoi.
                    @if (hasLoyaltyCard && loyaltyDiscountPercent > 0 && !string.IsNullOrEmpty(loyaltyStatus))
                    {
                        <span class="d-block mt-1">
                            Twój status <strong>@loyaltyStatus</strong> daje Ci
                            <strong>@loyaltyDiscountPercent% rabatu</strong> na nocleg.
                        </span>
                    }
                </p>
            </div>
        </div>
    </div>

    @if (hasLoyaltyCard && loyaltyDiscountPercent > 0 && !string.IsNullOrEmpty(loyaltyStatus) && hasSearch)
    {
        <div class="loyalty-banner">
            <div>
                <div class="fw-bold mb-1">
                    <i class="bi bi-stars me-1"></i>
                    Program lojalnościowy – status @loyaltyStatus
                </div>
                <div class="small">
                    Ceny poniżej zawierają rabat <strong>@loyaltyDiscountPercent%</strong> na nocleg
                    naliczany dla Twojej karty lojalnościowej.
                </div>
            </div>
            <div class="text-end small">
                Dziękujemy, że wracasz do nas 💙
            </div>
        </div>
    }

    <!-- FILTRY / SZUKAJKA -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-12 col-md-3">
                    <label class="form-label">Przyjazd</label>
                    <input type="date" name="checkIn" class="form-control" value="@checkIn" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Wyjazd</label>
                    <input type="date" name="checkOut" class="form-control" value="@checkOut" />
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label">Cena od</label>
                    <input type="number" step="1" name="minPrice" class="form-control"
                           value="@minPrice" />
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label">Cena do</label>
                    <input type="number" step="1" name="maxPrice" class="form-control"
                           value="@maxPrice" />
                </div>
                <div class="col-12 col-md-2">
                    <button type="submit" class="btn btn-primary w-100 mt-3 mt-md-0">
                        <i class="bi bi-search me-1"></i> Szukaj
                    </button>
                </div>
            </form>
        </div>
    </div>

    @if (!hasSearch)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-1"></i>
            Aby zobaczyć dostępne typy pokoi, wybierz datę przyjazdu i wyjazdu, a następnie kliknij <strong>Szukaj</strong>.
        </div>
    }
    else if (Model == null || !Model.Any())
    {
        <div class="alert alert-warning">
            Brak dostępnych typów pokoi dla wybranych dat. Spróbuj zmienić daty lub liczbę osób.
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var roomType in Model)
            {
                var isAvailable = availability != null && availability.ContainsKey(roomType.Id) && availability[roomType.Id] > 0;
                var availableCount = availability != null && availability.ContainsKey(roomType.Id) ? availability[roomType.Id] : 0;

                var basePrice = roomType.PricePerNight;
                decimal finalPrice = basePrice;

                if (hasLoyaltyCard && loyaltyDiscount > 0)
                {
                    finalPrice = Math.Round(basePrice * (1 - loyaltyDiscount), 2);
                }

                <div class="col-12 col-md-6 col-lg-4">
                    <div class="room-card h-100 d-flex flex-column">
                        @if (!string.IsNullOrEmpty(roomType.ImagePath))
                        {
                            <img src="@roomType.ImagePath" alt="@roomType.Name" class="room-image" />
                        }
                        else
                        {
                            <div class="room-image d-flex align-items-center justify-content-center bg-light text-muted">
                                <i class="bi bi-building fs-1"></i>
                            </div>
                        }

                        <div class="p-3 d-flex flex-column flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="mb-1">@roomType.Name</h5>
                                    <div class="text-muted small">
                                        @roomType.Description
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-light text-dark border">
                                        <i class="bi bi-people me-1"></i>@roomType.Capacity os.
                                    </span>
                                    <div class="mt-1">
                                        @if (isAvailable)
                                        {
                                            <span class="badge bg-success-subtle text-success border-success">
                                                Dostępne: @availableCount
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger-subtle text-danger border-danger">
                                                Wyprzedany
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="mt-auto d-flex justify-content-between align-items-end">
                                <div>
                                    @if (hasLoyaltyCard && loyaltyDiscount > 0)
                                    {
                                        <div class="price-line-through">
                                            @basePrice.ToString("0.00") zł / noc
                                        </div>
                                        <div class="fw-bold fs-5 text-success">
                                            @finalPrice.ToString("0.00") zł
                                            <span class="small text-muted">/ noc</span>
                                        </div>
                                        <div class="small text-muted">
                                            Rabat lojalnościowy @loyaltyDiscountPercent% zastosowany.
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="fw-bold fs-5">
                                            @basePrice.ToString("0.00") zł
                                            <span class="small text-muted">/ noc</span>
                                        </div>
                                    }
                                </div>
                                <div class="text-end">
                                    @if (isAvailable)
                                    {
                                        <a asp-controller="RoomType"
                                           asp-action="Reserve"
                                           asp-route-roomTypeId="@roomType.Id"
                                           asp-route-checkIn="@checkIn"
                                           asp-route-checkOut="@checkOut"
                                           class="btn btn-primary">
                                            Wybierz
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="btn btn-outline-secondary" disabled>Wyprzedany</button>
                                    }

                                    @if (isAdminOrManager)
                                    {
                                        <div class="mt-2">
                                            <a asp-controller="RoomType"
                                               asp-action="Edit"
                                               asp-route-id="@roomType.Id"
                                               class="btn btn-sm btn-outline-secondary">
                                                Edytuj
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
