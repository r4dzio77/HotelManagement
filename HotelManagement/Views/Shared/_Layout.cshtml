@using Microsoft.AspNetCore.Identity
@using HotelManagement.Models
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject HotelManagement.Services.IBusinessDateProvider BusinessDateProvider

@{
    ApplicationUser currentUser = null;
    var isSignedIn = SignInManager.IsSignedIn(User);

    if (isSignedIn)
    {
        currentUser = await UserManager.GetUserAsync(User);
    }

    var path = Context.Request.Path.Value?.ToLower() ?? "";

    var isAdmin = User.IsInRole("Admin");
    var isManager = User.IsInRole("Kierownik");
    var isStaff = User.IsInRole("Pracownik");

    var businessDate = await BusinessDateProvider.GetCurrentBusinessDateAsync();
}

<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - HotelManagement</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --hm-bg-page: #f3f4f6;
            --hm-bg-main: #ffffff;
            --hm-bg-sidebar: #020617;
            --hm-border-subtle: rgba(148, 163, 184, 0.4);
            --hm-accent: #2563eb;
            --hm-text-main: #0f172a;
            --hm-text-muted: #6b7280;
        }

        body {
            background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.16), transparent 60%), radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.12), transparent 55%), var(--hm-bg-page);
            min-height: 100vh;
            font-family: "Inter", sans-serif;
            color: var(--hm-text-main);
        }

        .app-shell {
            min-height: 100vh;
            display: flex;
        }

        /* SIDEBAR */

        .app-sidebar {
            width: 240px;
            background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.3), transparent 55%), #020617;
            color: #e5e7eb;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(15, 23, 42, 0.9);
        }

        .sidebar-header {
            padding: 1rem 1.25rem .75rem;
            border-bottom: 1px solid rgba(15, 23, 42, 0.9);
        }

        .sidebar-brand-link {
            display: flex;
            align-items: center;
            gap: .6rem;
            text-decoration: none;
            color: inherit;
            padding: .25rem 0;
            border-radius: .5rem;
            transition: .16s ease;
        }

            .sidebar-brand-link:hover {
                background: rgba(255,255,255,.05);
                transform: translateY(-1px);
            }

        .sidebar-logo {
            width: 34px;
            height: 34px;
            border-radius: .9rem;
            background: radial-gradient(circle at 15% 0%, #38bdf8, transparent 55%), radial-gradient(circle at 85% 100%, #6366f1, transparent 55%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            box-shadow: 0 8px 22px rgba(0,0,0,0.35);
        }

        .sidebar-title-main {
            font-size: .95rem;
            font-weight: 600;
            letter-spacing: .05em;
            text-transform: uppercase;
        }

        .sidebar-title-sub {
            font-size: .7rem;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .sidebar-nav {
            padding: .85rem .75rem 1rem;
            flex: 1;
        }

        .sidebar-section-label {
            font-size: .72rem;
            text-transform: uppercase;
            letter-spacing: .16em;
            color: #6b7280;
            padding: .25rem .5rem;
            margin-bottom: .4rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            margin-bottom: .25rem;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: .6rem;
            padding: .45rem .6rem;
            border-radius: .7rem;
            color: #d1d5db;
            text-decoration: none;
            font-size: .88rem;
            transition: .16s ease;
        }

            .sidebar-link:hover {
                background: rgba(255,255,255,.05);
                color: #fff;
                transform: translateY(-1px);
            }

            .sidebar-link.active {
                background: rgba(59,130,246,.25);
                border-left: 3px solid #3b82f6;
                color: #fff;
            }

        .sidebar-footer {
            padding: .7rem .9rem .9rem;
            border-top: 1px solid rgba(15,23,42,.9);
            font-size: .78rem;
            color: #9ca3af;
        }

        /* MAIN AREA */

        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .app-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .75rem 1.6rem;
            background: rgba(249,250,251,0.95);
            border-bottom: 1px solid rgba(209,213,219,0.9);
            backdrop-filter: blur(12px);
        }

        .topbar-title-main {
            font-weight: 600;
            font-size: 1rem;
        }

        .badge-date {
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,.7);
            padding: .25rem .75rem;
            font-size: .78rem;
            background: white;
        }

        .app-content {
            padding: 1.2rem 1.6rem 1.5rem;
        }

        .app-content-inner {
            border-radius: 1rem;
            background: white;
            padding: 1.3rem;
            max-width: 1300px;
            margin-inline: auto;
            min-height: calc(100vh - 120px);
            border: 1px solid rgba(209,213,219,0.7);
            box-shadow: 0 18px 45px rgba(15,23,42,.12);
        }

        .app-footer {
            padding: .7rem 1.6rem 1rem;
            max-width: 1300px;
            margin-inline: auto;
            color: var(--hm-text-muted);
            font-size: .78rem;
            display: flex;
            justify-content: space-between;
        }
    </style>

    @RenderSection("Styles", required: false)
</head>
<body>

    <div class="app-shell">
        <!-- SIDEBAR -->
        <aside class="app-sidebar">

            <!-- 🔗 LOGO + HOTEL PMS LINK -->
            <div class="sidebar-header">
                <a href="/" class="sidebar-brand-link">
                    <div class="sidebar-logo">
                        <i class="bi bi-building"></i>
                    </div>
                    <div>
                        <div class="sidebar-title-main">Hotel PMS</div>
                        <div class="sidebar-title-sub">INŻYNIERKA</div>
                    </div>
                </a>
            </div>
            <div class="sidebar-nav">
                <div class="sidebar-section-label">Główne</div>
                <ul class="sidebar-menu">

                    @if (isAdmin || isManager || isStaff)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Dashboard"
                               class="sidebar-link @(path.StartsWith("/dashboard") ? "active" : "")">
                                <i class="bi bi-speedometer2"></i>
                                Dashboard
                            </a>
                        </li>
                    }

                    @if (isAdmin || isManager || isStaff)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Reservation"
                               class="sidebar-link @(path.StartsWith("/reservation") ? "active" : "")">
                                <i class="bi bi-calendar-check"></i>
                                Rezerwacje
                            </a>
                        </li>

                        <li class="sidebar-menu-item">
                            <a href="/Housekeeping/Floor"
                               class="sidebar-link @(path.StartsWith("/housekeeping/floor") ? "active" : "")">
                                <i class="bi bi-building-fill-check"></i>
                                Floor plan
                            </a>
                        </li>
                    }

                    @if (isAdmin || isManager)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Reservation/Search"
                               class="sidebar-link @(path.StartsWith("/search") ? "active" : "")">
                                <i class="bi bi-search"></i>
                                Wyszukiwarka
                            </a>
                        </li>
                    }

                    @if (isManager || isStaff)
                    {
                        <li class="sidebar-menu-item">
                            <a href="javascript:void(0);" onclick="showAvailability(); return false;"
                               class="sidebar-link">
                                <i class="bi bi-grid-3x3-gap-fill"></i>
                                Dostępność pokoi
                            </a>
                        </li>
                    }

                    @if (isManager)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Shift/ManageSchedule"
                               class="sidebar-link @(path.StartsWith("/shift/manageschedule") ? "active" : "")">
                                <i class="bi bi-calendar-week"></i>
                                Grafik (kierownik)
                            </a>
                        </li>
                    }
                    else if (isStaff)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Shift/MySchedule"
                               class="sidebar-link @(path.StartsWith("/shift/myschedule") ? "active" : "")">
                                <i class="bi bi-calendar-week"></i>
                                Mój grafik
                            </a>
                        </li>
                    }

                    @if (isManager || isStaff)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/NightAudit"
                               class="sidebar-link @(path.StartsWith("/nightaudit") ? "active" : "")">
                                <i class="bi bi-moon-stars"></i>
                                Nocny audyt
                            </a>
                        </li>
                    }

                    @if (isAdmin || isManager)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Reports"
                               class="sidebar-link @(path.StartsWith("/reports") ? "active" : "")">
                                <i class="bi bi-bar-chart"></i>
                                Raporty
                            </a>
                        </li>
                    }

                    @if (isAdmin || isManager)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Employees"
                               class="sidebar-link @(path.StartsWith("/employees") ? "active" : "")">
                                <i class="bi bi-people"></i>
                                Pracownicy
                            </a>
                        </li>
                    }

                    @if (isAdmin)
                    {
                        <li class="sidebar-menu-item">
                            <a href="/Settings"
                               class="sidebar-link @(path.StartsWith("/settings") ? "active" : "")">
                                <i class="bi bi-gear"></i>
                                Ustawienia
                            </a>
                        </li>
                    }

                </ul>
            </div>

            <div class="sidebar-footer">
                @if (currentUser == null)
                {
                    <div class="d-flex flex-column gap-2">
                        <a class="sidebar-action-btn" asp-controller="Account" asp-action="Login">
                            <i class="bi bi-door-open"></i>
                            Zaloguj się
                        </a>

                        <a class="sidebar-action-btn" asp-controller="Account" asp-action="Register">
                            <i class="bi bi-person-plus"></i>
                            Załóż konto
                        </a>
                    </div>
                }
            </div>

        </aside>

        <!-- MAIN CONTENT -->
        <div class="app-main">

            <header class="app-topbar">
                <div class="d-flex flex-column">
                    <span class="topbar-title-main">@ViewData["Title"]</span>
                    <span class="text-muted" style="font-size:.78rem;">HotelManagement · Panel</span>
                </div>

                <div class="d-flex align-items-center gap-3">
                    <span class="badge-date">
                        <i class="bi bi-calendar"></i>
                        @businessDate.ToString("dd.MM.yyyy")
                    </span>

                    @if (currentUser != null)
                    {
                        <div class="dropdown">
                            <button class="topbar-user-btn" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle"></i>
                                @(string.IsNullOrWhiteSpace(currentUser.FirstName)
                                                            ? currentUser.UserName
                                                            : currentUser.FirstName + " " + currentUser.LastName)
                            <i class="bi bi-chevron-down"></i>
                        </button>

                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" asp-controller="AccountSettings" asp-action="Index">
                                        <i class="bi bi-person-gear me-2"></i>Ustawienia konta
                                    </a>
                                </li>
                                <li>
                                    <form asp-controller="Account" asp-action="Logout" method="post">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-box-arrow-right me-2"></i>Wyloguj
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                                        }
                </div>
            </header>

            <main class="app-content">
                <div class="app-content-inner">
                    @RenderBody()
                </div>
            </main>

            <footer class="app-footer">
                <span>&copy; @businessDate.Year · HotelManagement</span>
                <span>INŻYNIERKA</span>
            </footer>

        </div>
    </div>


    <!-- MODAL dostępności -->
    <div class="modal fade" id="availabilityModal">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dostępność pokoi</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="availabilityContent">
                        Ładowanie...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function showAvailability(startDate, days = 7) {
            const date = startDate || new Date().toISOString().split("T")[0];
            fetch(`/Availability/Partial?startDate=${date}&days=${days}`)
                .then(r => r.text())
                .then(html => {
                    document.getElementById("availabilityContent").innerHTML = html;
                    new bootstrap.Modal(document.getElementById("availabilityModal")).show();
                });
        }
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>
