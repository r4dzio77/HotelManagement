@model HotelManagement.ViewModels.ReservationViewModel

@{
    ViewData["Title"] = "Edytuj rezerwację";
}

<h2>Edytuj rezerwację</h2>

<form asp-action="Edit" method="post">
    @Html.HiddenFor(m => m.Reservation.Id)

    <!-- Dane gościa -->
    <h4 class="mt-4">Dane gościa</h4>

    <div class="form-group">
        <label asp-for="Guest.FirstName"></label>
        <input asp-for="Guest.FirstName" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="Guest.LastName"></label>
        <input asp-for="Guest.LastName" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="Guest.Email"></label>
        <input asp-for="Guest.Email" class="form-control" type="email" />
    </div>

    <div class="form-group">
        <label asp-for="Guest.PhoneNumber"></label>
        <input asp-for="Guest.PhoneNumber" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="Guest.Preferences"></label>
        <textarea asp-for="Guest.Preferences" class="form-control"></textarea>
    </div>

    <hr />

    <!-- Dane rezerwacji -->
    <h4 class="mt-4">Dane rezerwacji</h4>

    <div class="form-group">
        <label asp-for="Reservation.RoomTypeId">Typ pokoju</label>
        <select asp-for="Reservation.RoomTypeId" asp-items="Model.RoomTypes" class="form-control" id="RoomTypeId" onchange="updatePrice()"></select>
    </div>

    <div class="form-group">
        <label asp-for="Reservation.CheckIn">Data zameldowania</label>
        <input asp-for="Reservation.CheckIn" class="form-control" type="date" id="CheckIn" onchange="updatePrice()" />
    </div>

    <div class="form-group">
        <label asp-for="Reservation.CheckOut">Data wymeldowania</label>
        <input asp-for="Reservation.CheckOut" class="form-control" type="date" id="CheckOut" onchange="updatePrice()" />
    </div>

    <div class="form-group">
        <label for="PersonCount">Liczba osób:</label>
        <input type="number" class="form-control" id="PersonCount" name="PersonCount" value="@Model.PersonCount" min="1" max="10" onchange="updatePrice()" />
    </div>

    <!-- Hybrydowy wybór pokoju -->
    <div class="form-group">
        <label asp-for="RoomId">Wybierz pokój:</label>
        <select asp-for="RoomId" asp-items="Model.AvailableRooms" class="form-control"></select>
    </div>

    <label>Dodatkowe usługi:</label><br />
    <div class="form-check">
        <input asp-for="Breakfast" class="form-check-input" type="checkbox" id="Breakfast" onchange="updatePrice()" />
        <label asp-for="Breakfast" class="form-check-label">Śniadanie</label>
    </div>

    <div class="form-check">
        <input asp-for="Parking" class="form-check-input" type="checkbox" id="Parking" onchange="updatePrice()" />
        <label asp-for="Parking" class="form-check-label">Parking</label>
    </div>

    <div class="form-check">
        <input asp-for="ExtraBed" class="form-check-input" type="checkbox" id="ExtraBed" onchange="updatePrice()" />
        <label asp-for="ExtraBed" class="form-check-label">Dodatkowe łóżko</label>
    </div>

    <!-- Usługi dodatkowe -->
    <div class="form-group mt-3">
        @foreach (var service in Model.Services)
        {
            <div class="form-check">
                <input type="checkbox" name="SelectedServiceIds" value="@service.Id" class="form-check-input"
                       id="service-@service.Id" onchange="updatePrice()"
                       @(Model.SelectedServiceIds.Contains(service.Id) ? "checked" : "") />
                <label class="form-check-label" for="service-@service.Id">@service.Name (@service.Price PLN)</label>
            </div>
        }
    </div>

    <div class="mt-3">
        <strong>Cena: <span id="priceDisplay">0.00 PLN</span></strong>
    </div>

    <button type="submit" class="btn btn-primary mt-4">Zapisz zmiany</button>
</form>

<script>
    async function updatePrice() {
        const data = {
            roomTypeId: parseInt(document.getElementById("RoomTypeId").value),
            checkIn: document.getElementById("CheckIn").value,
            checkOut: document.getElementById("CheckOut").value,
            breakfast: document.getElementById("Breakfast").checked,
            parking: document.getElementById("Parking").checked,
            extraBed: document.getElementById("ExtraBed").checked,
            personCount: parseInt(document.getElementById("PersonCount").value),
            selectedServiceIds: Array.from(document.querySelectorAll("input[name='SelectedServiceIds']:checked")).map(e => parseInt(e.value))
        };

        const response = await fetch('/api/ReservationApi/CalculatePrice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            document.getElementById("priceDisplay").innerText = result.totalPrice.toFixed(2) + " PLN";
        } else {
            document.getElementById("priceDisplay").innerText = "Błąd";
        }
    }

    document.addEventListener("DOMContentLoaded", updatePrice);
</script>
