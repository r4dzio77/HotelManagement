@model HotelManagement.ViewModels.ReservationViewModel

@{
    ViewData["Title"] = "Edytuj rezerwację";
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-pencil-square me-2"></i> Edytuj rezerwację</h2>
            <p class="text-muted mb-0">Zmień dane gościa, termin pobytu oraz usługi dodatkowe.</p>
        </div>
    </div>

    <form asp-action="Edit" method="post">
        @Html.HiddenFor(m => m.Reservation.Id)

        <!-- ======= KARTA: DANE GOŚCIA ======= -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light fw-semibold">
                <i class="bi bi-person-circle me-2"></i> Dane gościa
            </div>
            <div class="card-body">

                <div class="row g-3">

                    <div class="col-md-6">
                        <label asp-for="Guest.FirstName" class="form-label">Imię</label>
                        <input asp-for="Guest.FirstName" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Guest.LastName" class="form-label">Nazwisko</label>
                        <input asp-for="Guest.LastName" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Guest.Email" class="form-label">Email</label>
                        <input asp-for="Guest.Email" type="email" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Guest.PhoneNumber" class="form-label">Telefon</label>
                        <input asp-for="Guest.PhoneNumber" class="form-control" />
                    </div>

                    <div class="col-12">
                        <label asp-for="Guest.Preferences" class="form-label">Preferencje</label>
                        <textarea asp-for="Guest.Preferences" class="form-control" rows="3"></textarea>
                    </div>

                </div>

            </div>
        </div>

        <!-- ======= KARTA: DANE REZERWACJI ======= -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light fw-semibold">
                <i class="bi bi-calendar-check me-2"></i> Dane rezerwacji
            </div>

            <div class="card-body">

                <div class="row g-3">

                    <div class="col-md-6">
                        <label asp-for="Reservation.RoomTypeId" class="form-label">Typ pokoju</label>
                        <select asp-for="Reservation.RoomTypeId" asp-items="Model.RoomTypes" class="form-select" id="RoomTypeId" onchange="updatePrice()"></select>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="Reservation.CheckIn" class="form-label">Zameldowanie</label>
                        <input asp-for="Reservation.CheckIn" type="date" class="form-control" id="CheckIn" onchange="updatePrice()" />
                    </div>

                    <div class="col-md-3">
                        <label asp-for="Reservation.CheckOut" class="form-label">Wymeldowanie</label>
                        <input asp-for="Reservation.CheckOut" type="date" class="form-control" id="CheckOut" onchange="updatePrice()" />
                    </div>

                    <div class="col-md-3">
                        <label for="PersonCount" class="form-label">Liczba osób</label>
                        <input type="number" class="form-control" id="PersonCount" name="PersonCount" value="@Model.PersonCount" min="1" max="10" onchange="updatePrice()" />
                    </div>

                    <div class="col-md-9">
                        <label asp-for="RoomId" class="form-label">Pokój</label>
                        <div class="input-group">
                            <input asp-for="RoomId" class="form-control" readonly id="RoomId" />
                            <button type="button" class="btn btn-outline-secondary" id="chooseRoomBtn">
                                <i class="bi bi-search"></i> Wybierz
                            </button>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <!-- ======= KARTA: USŁUGI DODATKOWE (TYLKO 4!) ======= -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light fw-semibold">
                <i class="bi bi-bag-plus me-2"></i> Usługi dodatkowe
            </div>

            <div class="card-body">

                <div class="row g-2">

                    <!-- Śniadanie -->
                    <div class="col-md-3">
                        <div class="form-check">
                            <input asp-for="Breakfast" class="form-check-input" type="checkbox" id="Breakfast" onchange="updatePrice()" />
                            <label class="form-check-label" for="Breakfast">
                                Śniadanie (+40 zł/os/doba)
                            </label>
                        </div>
                    </div>

                    <!-- Parking -->
                    <div class="col-md-3">
                        <div class="form-check">
                            <input asp-for="Parking" class="form-check-input" type="checkbox" id="Parking" onchange="updatePrice()" />
                            <label class="form-check-label" for="Parking">
                                Parking (+30 zł/doba)
                            </label>
                        </div>
                    </div>

                    <!-- Dodatkowe łóżko -->
                    <div class="col-md-3">
                        <div class="form-check">
                            <input asp-for="ExtraBed" class="form-check-input" type="checkbox" id="ExtraBed" onchange="updatePrice()" />
                            <label class="form-check-label" for="ExtraBed">
                                Dodatkowe łóżko (+80 zł/doba)
                            </label>
                        </div>
                    </div>

                    <!-- Zwierzę -->
                    <div class="col-md-3">
                        <div class="form-check">
                            <input asp-for="Pet" class="form-check-input" type="checkbox" id="Pet" onchange="updatePrice()" />
                            <label class="form-check-label" for="Pet">
                                Zwierzę (+80 zł/doba)
                            </label>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <!-- CENA -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h5 class="fw-semibold">Cena całkowita: <span id="priceDisplay" class="text-primary">0.00 PLN</span></h5>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-save me-2"></i> Zapisz zmiany
        </button>

    </form>
</div>

<!-- MODAL WYBORU POKOJU -->
<div class="modal fade" id="roomModal" tabindex="-1" aria-labelledby="roomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow-sm">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="bi bi-door-open me-2"></i> Wybierz pokój</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Numer pokoju</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="roomsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    async function updatePrice() {
        const data = {
            roomTypeId: parseInt(document.getElementById("RoomTypeId").value),
            checkIn: document.getElementById("CheckIn").value,
            checkOut: document.getElementById("CheckOut").value,
            breakfast: document.getElementById("Breakfast").checked,
            parking: document.getElementById("Parking").checked,
            extraBed: document.getElementById("ExtraBed").checked,
            pet: document.getElementById("Pet").checked,
            personCount: parseInt(document.getElementById("PersonCount").value),
            selectedServiceIds: [] // WYCIĘTE USŁUGI DODATKOWE
        };

        const response = await fetch('/api/ReservationApi/CalculatePrice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            document.getElementById("priceDisplay").innerText = result.totalPrice.toFixed(2) + " PLN";
        } else {
            document.getElementById("priceDisplay").innerText = "Błąd";
        }
    }

    document.addEventListener("DOMContentLoaded", updatePrice);

    // Wybór pokoju modal
    document.getElementById('chooseRoomBtn').addEventListener('click', function () {
        const roomTypeId = document.getElementById('RoomTypeId').value;
        const checkIn = document.getElementById('CheckIn').value;
        const checkOut = document.getElementById('CheckOut').value;

        fetch(`/Reservation/GetAvailableRooms?roomTypeId=${roomTypeId}&checkIn=${checkIn}&checkOut=${checkOut}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('roomsTableBody');
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Brak dostępnych pokoi</td></tr>';
                } else {
                    data.forEach(room => {
                        const row = `
                            <tr>
                                <td>${room.number}</td>
                                <td>${room.isClean ? 'Czysty' : 'Brudny'}</td>
                                <td class="text-end">
                                    <button class="btn btn-primary btn-sm select-room" data-id="${room.id}">
                                        Wybierz
                                    </button>
                                </td>
                            </tr>`;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                }

                var myModal = new bootstrap.Modal(document.getElementById('roomModal'));
                myModal.show();
            });
    });

    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('select-room')) {
            const roomId = e.target.dataset.id;
            document.getElementById('RoomId').value = roomId;
            bootstrap.Modal.getInstance(document.getElementById('roomModal')).hide();
        }
    });
</script>
