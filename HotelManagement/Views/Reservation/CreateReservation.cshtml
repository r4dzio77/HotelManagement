@model HotelManagement.ViewModels.ReservationViewModel

@{
    ViewData["Title"] = "Ustal szczegóły rezerwacji";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Ustal szczegóły rezerwacji</h2>
            <p class="text-muted mb-0">Dane gościa + parametry pobytu.</p>
        </div>
        <div class="text-end">
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
                <i class="bi bi-calendar-check me-1"></i> Nowa rezerwacja
            </span>
        </div>
    </div>

    <form asp-action="CreateReservation" method="post" class="mt-3">
        @Html.AntiForgeryToken()

        @* ID i wymagane pola gościa jako hidden – żeby przeszła walidacja w innych miejscach *@
        @if (Model.Guest != null)
        {
            <input type="hidden" asp-for="Guest.Id" />
            <input type="hidden" asp-for="Guest.FirstName" />
            <input type="hidden" asp-for="Guest.LastName" />
            <input type="hidden" asp-for="Guest.Email" />
            <input type="hidden" asp-for="Guest.PhoneNumber" />
        }

        <input type="hidden" asp-for="Reservation.Id" />
        <input type="hidden" asp-for="Reservation.GuestId" />

        @* PASEK BŁĘDÓW – tylko gdy faktycznie są błędy *@
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger" role="alert">
                <div asp-validation-summary="All"></div>
            </div>
        }

        <div class="row">
            <!-- LEWA KOLUMNA -->
            <div class="col-lg-8">
                <!-- Gość (podgląd) -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex align-items-center justify-content-between">
                        <span>
                            <i class="bi bi-person-badge me-2"></i>
                            <strong>Gość</strong>
                        </span>
                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">
                            Podgląd
                        </span>
                    </div>
                    <div class="card-body bg-light-subtle">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="Guest.FirstName" class="form-label small text-muted mb-1"></label>
                                <div class="form-control border-0 bg-white bg-opacity-75 rounded-3">
                                    @Model.Guest?.FirstName
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Guest.LastName" class="form-label small text-muted mb-1"></label>
                                <div class="form-control border-0 bg-white bg-opacity-75 rounded-3">
                                    @Model.Guest?.LastName
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Guest.Email" class="form-label small text-muted mb-1"></label>
                                <div class="form-control border-0 bg-white bg-opacity-75 rounded-3 d-flex align-items-center">
                                    <i class="bi bi-envelope-open me-2 text-muted"></i>
                                    <span>@Model.Guest?.Email</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Guest.PhoneNumber" class="form-label small text-muted mb-1"></label>
                                <div class="form-control border-0 bg-white bg-opacity-75 rounded-3 d-flex align-items-center">
                                    <i class="bi bi-telephone me-2 text-muted"></i>
                                    <span>@Model.Guest?.PhoneNumber</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rezerwacja -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <i class="bi bi-door-open me-2"></i>
                        <strong>Rezerwacja</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label asp-for="Reservation.RoomTypeId" class="form-label">Typ pokoju</label>
                                <select asp-for="Reservation.RoomTypeId"
                                        asp-items="Model.RoomTypes"
                                        class="form-select"
                                        id="RoomTypeId"
                                        onchange="updatePrice()">
                                </select>
                                <span asp-validation-for="Reservation.RoomTypeId" class="text-danger small"></span>
                            </div>

                            <div class="col-md-3">
                                <label for="PersonCount" class="form-label">Osoby</label>
                                <input type="number"
                                       class="form-control"
                                       id="PersonCount"
                                       name="PersonCount"
                                       value="@Model.PersonCount"
                                       min="1"
                                       max="10"
                                       onchange="updatePrice()" />
                                <span asp-validation-for="PersonCount" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4 d-flex align-items-end">
                                <div class="w-100">
                                    <label class="form-label d-block">Noce</label>
                                    <span class="badge bg-info-subtle text-info border border-info-subtle" id="nightsBadge">
                                        0 nocy
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Reservation.CheckIn" class="form-label">Zameldowanie</label>
                                <input asp-for="Reservation.CheckIn"
                                       class="form-control"
                                       type="date"
                                       id="CheckIn"
                                       onchange="updatePrice()" />
                                <span asp-validation-for="Reservation.CheckIn" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Reservation.CheckOut" class="form-label">Wymeldowanie</label>
                                <input asp-for="Reservation.CheckOut"
                                       class="form-control"
                                       type="date"
                                       id="CheckOut"
                                       onchange="updatePrice()" />
                                <span asp-validation-for="Reservation.CheckOut" class="text-danger small"></span>
                            </div>

                            <!-- Wybór pokoju -->
                            <div class="col-12">
                                <label asp-for="RoomId" class="form-label">Pokój (opcjonalnie)</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-hash"></i>
                                    </span>
                                    <input asp-for="RoomId"
                                           class="form-control"
                                           readonly
                                           id="RoomId"
                                           placeholder="Automatyczny przydział, jeśli puste" />
                                    <button type="button" class="btn btn-outline-secondary" id="chooseRoomBtn">
                                        <i class="bi bi-search"></i> Wybierz
                                    </button>
                                </div>
                                <span asp-validation-for="RoomId" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Usługi -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <i class="bi bi-bag-plus me-2"></i>
                        <strong>Usługi</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-2">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input asp-for="Breakfast"
                                           class="form-check-input"
                                           type="checkbox"
                                           id="Breakfast"
                                           onchange="updatePrice()" />
                                    <label asp-for="Breakfast" class="form-check-label">
                                        Śniadanie
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-check">
                                    <input asp-for="Parking"
                                           class="form-check-input"
                                           type="checkbox"
                                           id="Parking"
                                           onchange="updatePrice()" />
                                    <label asp-for="Parking" class="form-check-label">
                                        Parking
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-check">
                                    <input asp-for="ExtraBed"
                                           class="form-check-input"
                                           type="checkbox"
                                           id="ExtraBed"
                                           onchange="updatePrice()" />
                                    <label asp-for="ExtraBed" class="form-check-label">
                                        Dodatkowe łóżko
                                    </label>
                                </div>
                            </div>
                        </div>

                        <hr />

                        <div class="form-group mt-2">
                            <label class="form-label">Pozostałe usługi</label>

                            @if (Model.Services != null && Model.Services.Any())
                            {
                                <div class="row g-2">
                                    @foreach (var service in Model.Services
                                                                    .Where(s => s.Name != "Śniadanie"
                                                                    && s.Name != "Parking"
                                                                    && s.Name != "Dodatkowe łóżko"))
                                    {
                                        <div class="col-md-6">
                                            <div class="form-check border rounded-3 px-3 py-2 h-100">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       name="SelectedServiceIds"
                                                       value="@service.Id"
                                                       id="service_@service.Id"
                                                       onchange="updatePrice()" />
                                                <label class="form-check-label w-100" for="service_@service.Id">
                                                    <div class="d-flex justify-content-between">
                                                        <span>@service.Name</span>
                                                        <span class="fw-semibold">@service.Price.ToString("N2") PLN</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted small mb-0">
                                    Brak dodatkowych usług.
                                </p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRAWA KOLUMNA -->
            <div class="col-lg-4">
                <div class="card shadow-sm mb-3 position-sticky" style="top: 80px;">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-receipt me-2"></i> Podsumowanie</span>
                        
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="small text-muted">Cena całkowita</div>
                            <div class="fs-3 fw-bold" id="priceDisplay">0,00 PLN</div>
                        </div>

                        <hr />

                        <div class="mb-2">
                            <div class="small text-muted mb-1">Termin</div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-range me-2 text-muted"></i>
                                <span id="summaryDates">–</span>
                            </div>
                        </div>

                        <div class="mb-2">
                            <div class="small text-muted mb-1">Typ pokoju</div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-door-closed me-2 text-muted"></i>
                                <span id="summaryRoomType">Nie wybrano</span>
                            </div>
                        </div>

                        <div class="mb-2">
                            <div class="small text-muted mb-1">Osoby</div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-people me-2 text-muted"></i>
                                <span id="summaryPersonCount">@Model.PersonCount</span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-3">
                            <i class="bi bi-check-circle me-2"></i>
                            Zapisz rezerwację
                        </button>

                        <a asp-action="Index" asp-controller="Reservation" class="btn btn-link w-100 mt-2 text-muted">
                            <i class="bi bi-arrow-left"></i> Wróć
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- MODAL WYBORU POKOJU -->
<div class="modal fade" id="roomModal" tabindex="-1" aria-labelledby="roomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roomModalLabel">
                    <i class="bi bi-door-open me-2"></i> Wybierz pokój
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body">
                <table class="table table-sm table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Numer</th>
                            <th>Status</th>
                            <th class="text-end">Akcja</th>
                        </tr>
                    </thead>
                    <tbody id="roomsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function parseDate(value) {
            if (!value) return null;
            const parts = value.split("-");
            if (parts.length !== 3) return null;
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        function updateSummary() {
            const checkInVal = document.getElementById("CheckIn").value;
            const checkOutVal = document.getElementById("CheckOut").value;
            const personCount = parseInt(document.getElementById("PersonCount").value) || 0;

            const checkIn = parseDate(checkInVal);
            const checkOut = parseDate(checkOutVal);

            const summaryDates = document.getElementById("summaryDates");
            const nightsBadge = document.getElementById("nightsBadge");
            const summaryPerson = document.getElementById("summaryPersonCount");
            const summaryRoomType = document.getElementById("summaryRoomType");

            if (checkIn && checkOut) {
                const diffMs = checkOut - checkIn;
                const nights = diffMs / (1000 * 60 * 60 * 24);
                if (nights > 0) {
                    nightsBadge.textContent = nights + " " + (nights === 1 ? "noc" : (nights < 5 ? "noce" : "nocy"));
                } else {
                    nightsBadge.textContent = "0 nocy";
                }
                summaryDates.textContent = checkInVal + " → " + checkOutVal;
            } else {
                nightsBadge.textContent = "0 nocy";
                summaryDates.textContent = "–";
            }

            summaryPerson.textContent = personCount || 1;

            const roomSelect = document.getElementById("RoomTypeId");
            if (roomSelect && roomSelect.options.length > 0 && roomSelect.selectedIndex >= 0) {
                summaryRoomType.textContent = roomSelect.options[roomSelect.selectedIndex].text;
            }
        }

        async function updatePrice() {
            updateSummary();

            const roomTypeElement = document.getElementById("RoomTypeId");
            const checkInElement = document.getElementById("CheckIn");
            const checkOutElement = document.getElementById("CheckOut");
            const personCountElement = document.getElementById("PersonCount");

            if (!roomTypeElement || !checkInElement || !checkOutElement || !personCountElement) {
                return;
            }

            const roomTypeId = parseInt(roomTypeElement.value);
            const checkIn = checkInElement.value;
            const checkOut = checkOutElement.value;
            const personCount = parseInt(personCountElement.value);

            if (!roomTypeId || !checkIn || !checkOut || !personCount || personCount <= 0) {
                document.getElementById("priceDisplay").innerText = "0,00 PLN";
                return;
            }

            const data = {
                roomTypeId: roomTypeId,
                checkIn: checkIn,
                checkOut: checkOut,
                breakfast: document.getElementById("Breakfast").checked,
                parking: document.getElementById("Parking").checked,
                extraBed: document.getElementById("ExtraBed").checked,
                personCount: personCount,
                selectedServiceIds: Array.from(document.querySelectorAll("input[name='SelectedServiceIds']:checked"))
                    .map(e => parseInt(e.value))
            };

            try {
                const response = await fetch('/api/ReservationApi/CalculatePrice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById("priceDisplay").innerText =
                        result.totalPrice.toFixed(2).replace('.', ',') + " PLN";
                } else {
                    document.getElementById("priceDisplay").innerText = "Błąd";
                }
            } catch (e) {
                console.error(e);
                document.getElementById("priceDisplay").innerText = "Błąd połączenia";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            updatePrice();

            const chooseRoomBtn = document.getElementById('chooseRoomBtn');
            chooseRoomBtn.addEventListener('click', function () {
                const roomTypeId = document.getElementById('RoomTypeId').value;
                const checkIn = document.getElementById('CheckIn').value;
                const checkOut = document.getElementById('CheckOut').value;

                if (!roomTypeId || !checkIn || !checkOut) {
                    alert("Ustaw typ pokoju i daty.");
                    return;
                }

                fetch(`/Reservation/GetAvailableRooms?roomTypeId=${roomTypeId}&checkIn=${checkIn}&checkOut=${checkOut}`)
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById('roomsTableBody');
                        tableBody.innerHTML = '';

                        if (!data || data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Brak dostępnych pokoi</td></tr>';
                        } else {
                            data.forEach(room => {
                                const statusBadge = room.isClean
                                    ? '<span class="badge bg-success-subtle text-success">Czysty</span>'
                                    : '<span class="badge bg-warning-subtle text-warning">Brudny</span>';

                                const row = `<tr>
                                                <td>${room.number}</td>
                                                <td>${statusBadge}</td>
                                                <td class="text-end">
                                                    <button type="button"
                                                            class="btn btn-sm btn-primary select-room"
                                                            data-id="${room.id}">
                                                        Wybierz
                                                    </button>
                                                </td>
                                            </tr>`;
                                tableBody.insertAdjacentHTML('beforeend', row);
                            });
                        }

                        var myModal = new bootstrap.Modal(document.getElementById('roomModal'));
                        myModal.show();
                    });
            });

            document.addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('select-room')) {
                    const roomId = e.target.dataset.id;
                    document.getElementById('RoomId').value = roomId;
                    var myModalEl = document.getElementById('roomModal');
                    var modal = bootstrap.Modal.getInstance(myModalEl);
                    modal.hide();
                }
            });
        });
    </script>
}
